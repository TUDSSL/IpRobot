\chapter{Robot Design and Implementation}

% - Size and weight/energy availability/speed trade-off model and 
% - Should the subsections more or less reflect the columns in the table?
% - No optical encoders because they require a lot of energy!

\section{Design Requirements}

- Small form factor
- Navigation
- Power (should not rely on batteries)
- Tradeoff chargetime and operation time
- Weight of the robot
- Low voltage decreases power consumption of components and allows efficient use of the energy from the supercapacitor
- Single mainboard design
- Only move on flat surfaces!
- Limited resources (no power hungry components)
	
\section{Hardware Implementation}

\subsection{Computation and Sensing}

The robot is designed around a modified WISP 5.0, utilizing the processor and backscatter communication.
It's based around a Texas Instruments MSP430FR5969 ultra low power microcontroller, operating at 16 MHz and featuring 64 KB FRAM, 2 KB SRAM and 40 IO. 

%The harvester IC is removed from the WISP in order to allow an external harvester to supply the power to the system by harvesting solar energy. 

The mainboard is the platform that connects everything together.
Most reference designs are extendable but this adds complexity, while weight and size are the main constraints of this robot design.
All the sensors can be interfaced trough a I2C connection.
To conserve as much power as possible each sensor can be enabled and disabled using dedicated pins.

For avoidance of obstacles, a Maxim Integrated MAX44000 proximity sensor was added of the robot facing forward.
This sensor can measure the amount of ambient light as well.
In addition the robot has a Bosch BMG250 Mems Gyroscope to measure yaw angle change and correct when necessary.

\subsection{Locomotion}

Two 6mm geared dc motors from Precision Microdrives are mounted in a 3d printed frame, directly under the mainboard of the IPR.
The motors are mounted diagonally opposite from each other making the robot as compact as possible.
A small wheel is mounted directly on the motor shaft and in the other diagonally opposite corners a free running wheel is mounted to the frame.
The speed of each motor can be controlled individually using a dual H-bridge, this differential drive configuration allows the robot to steer.

%The buck converter is can only supply 110mA of current.
On average the each motor consumes 38mA while running on a flat surface, which is well within the current limit that the buck converter can supply.
However when the motors are in not moving yet the inrush/start current is equal to the stall current, which is equal to 240mA for each motor.
This amount of current can not be supplied by the powersupply, using PWM to soft start the motor the average current can be limited and allowing a bulk capacitor to supply the voltage.

\subsection{Energy Harvesting}
\label{subsec:energy_harvesting}

% RF harvesting seems prommesing
% better to only use RF for communication and harvest energy from another source \cite{konstantioulos}
% wispcam long time to charge

%Photovoltaic cells used for indoor and outdoor energy harvesting, commonly have a different spectral sensitivity depending on the nature of their sources.
%Solar cells used in indoor applications need to have a high spectral sensitivity in the range of visible light (400 to 700nm).
%While for outdoor applications have a spectral sensitivity range can be broader, including near infrared  (500 nm to 1100 nm).
%Triple junction solar cells harvest in some cases up to 50\% of there energy out of the near infrared range.
% reference to paper tudelft!

% http://www.chip1stop.com/web/RUS/en/tutorialContents.do?page=009

The solar energy harvesting system is based around a Texas Instruments BQ25570. 
It includes a nano power boost charger with maximum power point tracking to extract the optimal amount of energy from the solar panel. 
% Why is this size capacitor chosen?
This harvested energy is stored in a 22mF - 4.5V supercapactor from AVX, chosen for it's low leakage current and small size.
The energy stored in supercap is a function of the capacitance and voltage difference between the plates, being equal to:

\begin{equation}
\label{eq:cap1}
E = \frac{1}{2}CV^{2}
\end{equation}

However, to be able to use the energy stored in the capacitor efficiently a voltage regular is required to supply a stable voltage to the connected loads.
The regulated output voltage is a lower threshold of the energy that can be used from the capacitor.
Lowering the output voltage allows for more energy to be used from the supercapacitor, but in general also lowers the power consumption of individual components. Rewriting Equation \ref{eq:cap1} results in Equation \ref{eq:cap2}:

\begin{equation}
\label{eq:cap2}
E = \frac{1}{2}C(V_{max} - V_{min})^{2}
\end{equation}

The Texas Insturments BQ25570 has a buck converter to efficiently regulate the capacitor voltage down to a system voltage of 2.2 Volt.

% The maximum speed that can be reached is dependent on the voltage supplied to the motors.
% The current consumed by the motors also decreases with a lower voltaged supplied. 
% The buck converter can supply up to 110mA of output current.
% Powering both motors and MCU should not exceed this current limit.

\section{Software Implementation}

% General library for reading and writing to i2c.

% How program consistency (ie progress) is maintained given the intermittend nature of the robot.

% A operating system for intermittend devices

\subsection{Calibration of the motors}
\label{subsub:motor_calib}

% Write about why valid to assume a constant speed on a single surface
In robotics the motors are commonly powered directly from the battery as linear or switch-mode power regulators are not able to supply the high start-up currents.
When the motors are powered from the battery the supplied voltages drops while energy is consumed for the battery.
Since the speed of the motor is dependent on the supply voltage the speed of the motor will also decrease while energy is consumed from the battery.
However, the use of a supercapacitor requires a regulator to make efficient use of the energy stored, as described in section \ref{subsec:energy_harvesting}.
A benefit of running a constant voltage is that the motor speed will be constant as well.
By making the assumption that the robot will only travel on a flat surface, the speed is considered constant given a certain PWM duty-cycle.

% Write about linear motion control dc motor vs pwm
% Reference: https://www.precisionmicrodrives.com/application-notes/ab-022-pwm-frequency-for-linear-motion-control

Pulse width modulation(PWM) is used to control the speed of the motors, by changing the duty cycle of the control pulse the average current through the motors can be changed.
The winding current is proportional to the torgue output of the motor and therefore the average winding current is proportional to the PWM dutycycle.
However this is only true for pure resistive loads,

%Typically operation frequency is above 20 khz (what people can hear)

% -Write how the pwm control signals are generated for the H-bridge.
The PWM signals are generated by the microcontroller on the WISP.
A timer running at a frequency of 2Khz is used to directly control the four io-ports which are connected to the H-bridge.

% -Write about maximum speed due to enabling two motors and their startup current peak! show figure!!
% -Write about current generated by the lack of Back-EMF
% -Use large capacitor to somewhat reduce the effect! NEED FIGURE!

The next step is to determine the minimum and maximum PWM duty-cycle that will enable the motor to turn.
A minimal PWM duty-cycle to produce a torque that is able to overcome the static friction between the wheels and the surface the robot is moving on.
Each motor is physically different and the friction in the gearbox can variate as well, which results in a different output output speed per motor.
Since the robot uses two motors in differential drive configuration, a minimum PWM duty-cycle has to be found for each motor.
This is accomplished by setting a PWM duty-cycle at which both motors are rotating and slowly backing down the PWM duty-cycle until one or both stop turning.

The maximum PWM duty-cycle is bounded by the amount of current that the buck converter and bulk capacitor can supply.
Lowering the PWM duty-cycle can reduce the current peak induced by the lack of back-EMF when the motor is in steady state.

% Does more gearing (more torque) reduce the current peak??
% How does pwm influcence the startup current of the motor in combination with a capacitor

\begin{equation}
\frac{dV}{dt} = \frac{I}{C}
\end{equation}

Allow 0.2V voltage drop (msp430 and motor driver stop working)

% DO calculation of current that can be supplied from capacitor buffer

 


\subsection{PID controller for controlled movements}


% -Write about three different commands. One for straight, left and right turning
% -Write about minimum output to motors (add min number), adding the minimum made it much more responsive and quicker to tune.
% -Write about bounding the pid output, because otherwise the motors of the robot could stall, if the motor setpoint is to high
% -Write about the pid controller itself one for straight based on angular velocity and one for turning based on angle

% -Controlloop run periodically using a (second) timer and interrupt routine running at 50Hz
% -Different methods for calculating setpoint straight and turning

% -Write about tuning the pid controller using Zieglerâ€“Nichols tuning method (method 2), closed loop, Critical gain.
% -Add figure with critcial gain + mark period Tu

The robots uses two physically different motors in differential drive configuration and they are mounted in a non-symmetrical way.
Open loop movement using just a calibrated motor values has been used in previous work \cite{legoc_uist_2016}, but it can be time consuming and any little disturbance will trow the robot off course.
The gyroscope is used to obtain the current yaw-rate and correct the robots heading.
Controlled movements are possible using closed loop feedback, PID control, where the heading is used to correct the motor control values.

The robot can be controlled using a function that accepts different commands, one for straight paths and two for turning.
Setting a new command executes a control loop, running at 50Hz using a timer, which will run until the "setpoint" is reached.











This can be used to correct the robots heading in closed loop feedback and keep the angular velocity close to zero.
This will enable the robot to move straight in a controlled way.


Turning 


Each movement uses different values for P, I and D, which are set before the movement is executed.

Each of the three movements was executed with different PID (proportional-integral-derivative) controllers. 





\subsection{Mapping of linear motion}